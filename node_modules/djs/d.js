var nowjs = require('now');
var Db = require('mongodb').Db;
var Connection = require('mongodb').Connection;
var Server = require('mongodb').Server;

var server
exports.initialize = function (theServer) {
	server = theServer
	var everyone = nowjs.initialize(server, {socketio:{"log level": process.argv[2]}});
	
	var usercoll;
	var mediacoll;
	var db = new Db('djs', new Server("localhost", 27017, {}), {native_parser:false});
	db.open(function(err, conn) {
		db = conn;
		db.collection('userinfo', function(err, coll) {
			usercoll = coll;
		});
		db.collection('mediainfo', function(err, coll) {
			mediacoll = coll;
		});
	});
	
	everyone.now.SbroadcastMedia = function (mId) {
		var self = this
		//usercoll.findOne({isKing: true}, function (err, doc) {
		//	if (doc.uId == self.user.clientId) {
				mediacoll.findOne({_id: new db.bson_serializer.ObjectID(mId)}, function (err, doc) {
					everyone.now.CplayMedia(doc);
				});
		//	}
		//});
	};
	
	everyone.now.SgetCurrentMedia = function () {
		
	}
	
	everyone.now.SfindMedia = function (searchQuery) {
		searchQuery = ("" + searchQuery).toLowerCase();
		var self = this;
		if (searchQuery === "") {
			var cursor = mediacoll.find({});
		 	cursor.toArray(function(err, array) {
				self.now.CreceiveSearchResults(array);
			});
		} else {
			var cursor = mediacoll.find({tags: searchQuery});
			cursor.toArray(function(err, array) {
				self.now.CreceiveSearchResults(array);
			});
		}
	}
	
	everyone.now.SaddMedia = function () {
		mediacoll.insert(
			{
				path: "http://images.wikia.com/vssaxtonhale/images/6/6a/Rainbow_dash_evil_looking.png",
				tags: ["rainbow", "dash", "dicks"]
			});
	}
	
	
	
	
	
	
}
